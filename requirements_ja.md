# 浦島効果デバイス 要件定義

## 概要
「浦島効果デバイス」は、相対性理論に基づく時間の遅れ（時間膨張）を体感するためのウェアラブルデバイスです。M5Stackハードウェアを使用し、GPSとIMUセンサーを組み合わせて移動速度を測定し、それに基づいて相対論的時間の経過を計算・表示します。

## 機能要件

### 1. 速度測定
- **GPS速度測定**: GPSモジュールを使用して正確な移動速度を測定
- **IMU速度測定**: 加速度センサーを使用した速度推定（GPS信号が弱い場合のバックアップ）
- **センサーフュージョン**: GPS速度とIMU速度の融合による精度向上（重み付け: GPS 20%, IMU 80%）
- **GPS有効性タイムアウト**: 5000ms以上GPSデータが更新されない場合、IMUデータに切り替え

### 2. 時間計算
- **デバイス時間**: 実際の経過時間を計測
- **相対論的時間**: 特殊相対性理論に基づく時間膨張を計算
  - 仮想光速: 0.3 km/s（実際の光速の約100万分の1）に設定
- **時間差**: デバイス時間と相対論的時間の差を計算・表示

### 3. 表示機能
- **メインディスプレイ**: 
  - 現在速度
  - デバイス時間（実時間）
  - 相対論的時間
  - 時間差
  - 総移動距離
- **GPSステータス表示**: GPS信号の状態を視覚的に表示
- **ディスプレイサイズ対応**: 小型（128x128）および大型ディスプレイに対応したレイアウト

### 4. 永続的ストレージ
- **IMUキャリブレーションデータ**: 
  - キャリブレーション値の保存と読み込み
  - キャリブレーション中のプログレスバー表示
- **最後の有効なGPS位置**: 
  - 緯度・経度・高度の保存
  - デバイス再起動時に読み込み
- **最後の有効なGPS速度**: 速度データの保存と読み込み
- **総移動距離**: 
  - 移動距離の累積計算と保存
  - 100m移動または5分ごとに自動保存

### 5. ユーザーインターフェース
- **ディスプレイモード切替**: メイン表示、GPS詳細、IMU詳細の切り替え
- **視覚的フィードバック**: 
  - キャリブレーション状態の表示
  - GPS信号強度の表示
  - 時間差の色分け表示（正常: 黄色、異常: シアン、ゼロ: 緑）

## 技術要件

### ハードウェア
- **対応デバイス**: M5Stackシリーズ（Core2, Core, StickC Plus等）
- **必須センサー**: 
  - GPSモジュール（UART接続）
  - IMU（加速度センサー、ジャイロスコープ）

### ソフトウェア
- **開発環境**: Arduino IDE
- **主要ライブラリ**: 
  - M5Unified: M5Stackデバイス統一ライブラリ
  - TinyGPS++: GPS解析ライブラリ
  - Preferences: 永続的ストレージライブラリ

### 通信
- **GPS通信**: UART（9600bps, 8N1）
- **デバッグ出力**: シリアルコンソール（115200bps）

## 制約条件
- **電力効率**: バッテリー駆動時間の最大化
- **処理負荷**: 限られたCPUリソースでの効率的な処理
- **メモリ使用**: 限られたRAMとフラッシュメモリ内での動作

## 将来の拡張性
- **Bluetooth接続**: スマートフォンアプリとの連携
- **データロギング**: 移動履歴の記録と分析
- **マルチモード**: 異なる仮想光速設定の切り替え
- **UI改善**: より直感的なユーザーインターフェース
