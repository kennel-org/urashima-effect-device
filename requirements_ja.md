# 浦島効果デバイス 要件定義

## 概要
「浦島効果デバイス」は、相対性理論に基づく時間の遅れ（時間膨張）を体感するためのウェアラブルデバイスです。M5Stackハードウェアを使用し、GPSとIMUセンサーを組み合わせて移動速度を測定し、それに基づいて相対論的時間の経過を計算・表示します。

## 機能要件

### 1. 速度測定
- **GPS速度測定**: GPSモジュールを使用して正確な移動速度を測定
- **IMU速度測定**: 加速度センサーを使用した速度推定（GPS信号が弱い場合のバックアップ）
- **センサーフュージョン**: GPS速度とIMU速度の融合による精度向上（重み付け: GPS 20%, IMU 80%）
- **GPS有効性タイムアウト**: 5000ms以上GPSデータが更新されない場合、IMUデータに切り替え

### 2. 時間計算
- **デバイス時間**: 実際の経過時間を計測
- **相対論的時間**: 特殊相対性理論に基づく時間膨張を計算
  - 仮想光速: 0.03 km/s（実際の光速の約1000万分の1）に設定
- **時間差**: デバイス時間と相対論的時間の差を計算・表示

### 3. 表示機能
- **メインディスプレイ**: 
  - 現在速度
  - デバイス時間（実時間）
  - 相対論的時間
  - 時間差
  - 総移動距離
- **GPSステータス表示**: GPS信号の状態を視覚的に表示
- **ディスプレイサイズ対応**: 小型（128x128）および大型ディスプレイに対応したレイアウト
- **表示モード**: 
  - メイン表示: 速度、時間情報、距離を表示
  - GPS RAW表示: GPS生データ（日時、位置、衛星数など）を表示
  - IMU RAW表示: 加速度、ジャイロ、推定速度データを最適化されたレイアウトで表示

### 4. データロギング
- **SDカードロギング**:
  - 移動データと時間膨張効果をCSVファイルに記録
  - ログファイルに自動的にヘッダーを作成
  - 新しいセッションごとにセパレーターを追加
  - 5秒ごとにデータをログに記録
- **ログデータ項目**:
  - タイムスタンプ
  - デバイス時間
  - 相対論的時間
  - 時間差
  - 速度
  - 緯度・経度
  - その他の関連データ

### 5. 永続的ストレージ
- **IMUキャリブレーションデータ**: 
  - キャリブレーション値の保存と読み込み
  - キャリブレーション中のプログレスバー表示
- **最後の有効なGPS位置**: 
  - 緯度・経度・高度の保存
  - デバイス再起動時に読み込み
- **最後の有効なGPS速度**: 速度データの保存と読み込み
- **総移動距離**: 
  - 移動距離の累積計算と保存
  - 100m移動または5分ごとに自動保存

### 6. ユーザーインターフェース
- **ディスプレイモード切替**: ボタン短押し（wasClicked）でメイン表示、GPS詳細、IMU詳細を順番に切り替え
- **視覚的フィードバック**: 
  - キャリブレーション状態の表示
  - GPS信号強度の表示
  - 時間差の色分け表示（正常: 黄色、異常: シアン、ゼロ: 緑）
  - SDカード状態の表示
- **時間・距離リセット機能**:
  - ボタンA長押し（2秒以上）で時間リセット確認画面を表示
  - 確認画面表示中にボタンAを押すとデバイス時間、相対論的時間、総移動距離をリセット
  - リセット完了時に「TIME RESET COMPLETE」メッセージを緑色背景で表示（1.5秒間）
  - 5秒間操作がない場合は確認画面をキャンセルし、「RESET CANCELLED」メッセージを黄色背景で表示（1.5秒間）

## 技術要件

### ハードウェア
- **対応デバイス**: M5Stack AtomS3R
- **必須センサー**: 
  - AtomicBase GPS（UART接続）
  - 内蔵IMU（加速度センサー、ジャイロスコープ）
- **オプション**:
  - microSDカード（データロギング用）

### ハードウェア接続
#### GPS接続
- GPS_TX_PIN: 5（AtomS3R GPIO5、GPSからデータを受信）
- GPS_RX_PIN: -1（未接続）

#### SDカード接続（AtomS3RとAtomicBase GPS）
- SD_MOSI_PIN: 6（MOSIピン G6）
- SD_MISO_PIN: 8（MISOピン G8）
- SD_SCK_PIN: 7（CLKピン G7）
- SD_CS_PIN: 38（CSピン G38）

**注意**: SDカードのCSピンにはGPIO38を使用することが重要です。GPIO5（GPS用）との競合を避けるため。

### ソフトウェア
- **開発環境**: Arduino IDE
- **主要ライブラリ**: 
  - M5Unified: M5Stackデバイス統一ライブラリ（v0.1.6以降）
  - TinyGPS++: GPS解析ライブラリ
  - SPI: SPIバス通信ライブラリ
  - SD: SDカード操作ライブラリ
  - FS: ファイルシステムライブラリ
  - Preferences: 永続的ストレージライブラリ

### 通信
- **GPS通信**: UART（9600bps, 8N1）
- **SDカード通信**: SPI（明示的なピン設定が必要）
  - SPI.begin(SD_SCK_PIN, SD_MISO_PIN, SD_MOSI_PIN, SD_CS_PIN)
  - SD.begin(SD_CS_PIN)
- **デバッグ出力**: シリアルコンソール（115200bps）

## 制約条件
- **電力効率**: バッテリー駆動時間の最大化
- **処理負荷**: 限られたCPUリソースでの効率的な処理
- **メモリ使用**: 限られたRAMとフラッシュメモリ内での動作
- **ハードウェア競合**: GPSとSDカードのピン競合を避けるための適切な設定

## トラブルシューティング

### ディスプレイが更新されない
ボタンを押してもディスプレイが正しく更新されない場合：
- GPSとSDカードの両方に対して正しいピン設定を使用していることを確認
- SD_CS_PINが38に設定されていることを確認（GPIO5とのGPS競合を避けるため）
- ボタン処理が`M5.BtnA.wasPressed()`ではなく`M5.BtnA.wasClicked()`を使用していることを確認
- `M5.update()`がloop()の先頭で呼び出されていることを確認

### SDカードが動作しない
SDカードが検出されないか、ディスプレイの問題を引き起こす場合：
- SDカードが正しくフォーマットされていることを確認（FAT32）
- SDカードのピンが正しく設定されていることを確認：
  ```
  SD_MOSI_PIN: 6
  SD_MISO_PIN: 8
  SD_SCK_PIN: 7
  SD_CS_PIN: 38
  ```
- SPI初期化が`SPI.begin(SD_SCK_PIN, SD_MISO_PIN, SD_MOSI_PIN, SD_CS_PIN)`で行われていることを確認
- 追加パラメータなしで`SD.begin(SD_CS_PIN)`を使用

### GPSがデータを受信しない
- GPS_TX_PINが5に設定されていることを確認
- GPS受信状態の良い場所に移動
- シリアル接続設定を確認（9600ボーレート）

## 将来の拡張性
- **Bluetooth接続**: スマートフォンアプリとの連携
- **データロギング拡張**: より詳細な移動履歴の記録と分析
- **マルチモード**: 異なる仮想光速設定の切り替え
- **UI改善**: より直感的なユーザーインターフェース
- **ワイヤレス同期**: 複数デバイス間での時間同期と比較
