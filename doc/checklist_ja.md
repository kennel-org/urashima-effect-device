# 浦島効果デバイス ビルド前チェックリスト

## 概要

このチェックリストは、浦島効果デバイスのビルド前に確認すべき項目をまとめたものです。これらの項目を確認することで、一般的なビルドエラーを事前に防ぐことができます。

## コード構造のチェック

### ヘッダファイル (.h)

- [ ] クラス宣言に必要なすべてのメンバー関数が含まれているか
- [ ] 関数宣言の引数の型と数が実装と一致しているか
- [ ] 必要なヘッダファイルがすべてインクルードされているか
- [ ] クラスの継承関係が正しく定義されているか
- [ ] 名前空間が適切に使用されているか

### 実装ファイル (.cpp)

- [ ] すべての宣言された関数に対応する実装があるか
- [ ] 関数の実装が宣言と一致しているか（引数の型、数、戻り値の型）
- [ ] クラスメソッドが `ClassName::methodName` の形式で定義されているか
- [ ] 同じ関数が複数回定義されていないか
- [ ] 必要なヘッダファイルがすべてインクルードされているか

### メインスケッチ (.ino)

- [ ] `setup()` と `loop()` 関数が正しく実装されているか
- [ ] 必要なライブラリがすべてインクルードされているか
- [ ] グローバル変数が適切に初期化されているか
- [ ] 関数呼び出しの引数が正しいか（型、数）

## 一般的なエラーのチェック

### 未定義シンボル

- [ ] 使用しているすべての変数、定数、関数が定義またはインクルードされているか
- [ ] 定数名が正しいか（例：`TFT_GRAY` ではなく `TFT_DARKGREY` を使用）
- [ ] 名前空間の指定が必要な場合、正しく指定されているか

### 型の不一致

- [ ] 関数の引数の型が宣言と一致しているか
- [ ] 変数の型が適切か（特に数値型の場合、int, float, doubleなど）
- [ ] キャストが必要な場合、適切にキャストされているか

### メモリ関連

- [ ] 大きな配列やバッファが適切なサイズで宣言されているか
- [ ] ヒープメモリの割り当てと解放が適切に行われているか
- [ ] スタックオーバーフローの可能性がある大きな局所変数がないか

## ハードウェア確認

- [ ] M5Stack AtomS3Rが正常に動作する
- [ ] M5Stack AtomicBase GPSが正常に接続されている
- [ ] microSDカードが正しくフォーマットされている（FAT32）
- [ ] 以下のピン設定が正しく行われている：
  - GPS_TX_PIN: 5
  - GPS_RX_PIN: -1
  - SD_MOSI_PIN: 6
  - SD_MISO_PIN: 8
  - SD_SCK_PIN: 7
  - SD_CS_PIN: 38（GPIO5との競合を避けるため）

## 特定機能のチェック

### IMUセンサー

- [ ] センサーの初期化コードが正しいか
- [ ] キャリブレーション処理が実装されているか
- [ ] センサーデータの読み取りと変換が正しく行われているか
- [ ] エラー処理が実装されているか

### GPS

- [ ] GPS_TX_PIN (5) と GPS_RX_PIN (-1) の設定が正しいか
- [ ] GPSデータの解析処理が正しく実装されているか
- [ ] 無効なGPSデータに対するエラー処理があるか

### ディスプレイ

- [ ] スプライトの初期化と解放が適切に行われているか
- [ ] `_sprite` がnullの場合の分岐処理が実装されているか
- [ ] 色定数が正しく使用されているか（TFT_で始まる定数）
- [ ] テキストサイズ、色、位置の設定が適切か

### 相対論的時間計算

- [ ] `calculateRelativisticEffect`メソッドが正しく実装されているか
- [ ] 速度に基づく時間膨張が正しく計算されているか
- [ ] 修正光速値（0.03 km/s）が適切に設定されているか
- [ ] 時間差の計算と表示が適切に行われているか
- [ ] 速度が閾値を超えた場合の処理が適切に実装されているか

### SDカードロギング

- [ ] SDカードの初期化コードが正しいか（CS_PIN = 38）
- [ ] ログファイルの作成と書き込みが適切に実装されているか
- [ ] セッション識別子やヘッダーが正しく書き込まれているか
- [ ] エラー処理が実装されているか

## ビルド環境のチェック

- [ ] Arduino IDEのバージョンが最新か
- [ ] 必要なすべてのライブラリがインストールされているか
- [ ] ボード設定が正しいか（m5stack:esp32:m5stack_atoms3r）
- [ ] コンパイルオプションが適切か

## 最終チェック

- [ ] すべてのファイルが保存されているか
- [ ] 一時的なデバッグコードやコメントアウトが残っていないか
- [ ] コードのフォーマットが一貫しているか
- [ ] 不要なコードや使われていない変数がないか

## ビルド後のチェック

- [ ] コンパイルエラーがないか
- [ ] 警告メッセージがないか
- [ ] ビルドサイズが適切か（フラッシュメモリとRAMの使用量）
- [ ] アップロード後に期待通りに動作するか

## ユーザー操作確認

### 基本操作

- [ ] 電源投入時に初期化画面が正しく表示される
- [ ] GPS信号取得時にGPSインジケーターが点灯する
- [ ] ボタン短押しで表示モードが切り替わる（メイン→GPS→IMU→メイン）
- [ ] ボタン長押し（2秒以上）でリセット確認画面が表示される
- [ ] リセット確認画面でボタン押下時に時間と距離がリセットされる
- [ ] リセット確認画面で5秒間無操作時にリセットがキャンセルされる

### 表示モード

- [ ] メインモード: 速度、時間、距離情報が正しく表示される
- [ ] GPSモード: GPS生データ（緯度、経度、高度、衛星数など）が正しく表示される
- [ ] IMUモード: IMUセンサーデータが正しく表示される

### 状態インジケーター

- [ ] GPS状態インジケーターが信号状態に応じて色が変わる（緑/黄/赤）
- [ ] IMU状態インジケーターが正しく表示される
- [ ] SDカード状態インジケーターが正しく表示される

## SDカードロギング

- [ ] SDカードが正しく初期化される
- [ ] ログファイルが正しく作成される
- [ ] 5秒ごとにデータが正しくログ記録される
- [ ] ログファイルが正しいCSV形式で保存される
- [ ] リセット時にログファイルにリセットマーカーが記録される

## トラブルシューティング

ビルドエラーが発生した場合は、以下の手順で対処してください：

1. エラーメッセージを注意深く読み、問題のあるファイルと行番号を特定
2. 該当する箇所のコードを確認し、上記のチェックリストに基づいて問題を特定
3. 一度に複数の変更を行った場合は、変更を一つずつ元に戻して問題の原因を特定
4. 解決できない場合は、`knowhow_ja.md` を参照するか、エラーメッセージを検索して解決策を探す

このチェックリストを定期的に更新し、新たに発見された問題や解決策を追加してください。
